<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Norway National Parks — External SVG Layers</title>
  <style>
    :root{
      --bg:#f8f9fb;
      --park:#b0b7c3;        /* default gray */
      --park-active:#2bb673; /* green when selected */
      --label:#6b7280;       /* default label gray */
      --label-active:#1f2937;/* darker when active */
      --stroke:#9aa4b2;      /* park stroke */
    }
    html, body {height:100%;}
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:#0f172a; display:grid; grid-template-rows:auto 1fr; }
    header { padding:12px 16px; border-bottom:1px solid #e5e7eb; background:#fff; display:flex; gap:12px; align-items:center; }
    header h1 { font-size:clamp(16px,2.2vw,20px); margin:0; font-weight:650; }
    .toolbar { margin-left:auto; display:flex; gap:8px; }
    button{ appearance:none; border:1px solid #e5e7eb; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer }
    .map-wrap{ position:relative; overflow:hidden; background:#e9eef5; }
    svg{ display:block; width:100%; height:100%; }

    /* Basemap non-interactive so clicks go to parks */
    #basemap, #basemap * { pointer-events:none; }

    /* Park shapes */
    .park { fill: var(--park); stroke: var(--stroke); stroke-width: 0.7; cursor:pointer; transition: fill .15s ease; }
    .park.active { fill: var(--park-active); }

    /* Labels */
    .label { font-size: 10px; fill: var(--label); pointer-events: none; transition: font-weight .15s ease, fill .15s ease; }
    .label.active { font-weight: 700; fill: var(--label-active); }

    @media (max-width: 480px){ .label{ font-size: 9px; } }
    .park:focus { outline: none; filter: drop-shadow(0 0 0.6px #1118); }
  </style>
</head>
<body>
  <header>
    <h1>Norway National Parks — External SVG</h1>
    <div class="toolbar">
      <button id="resetBtn" title="Reset zoom">Reset</button>
    </div>
  </header>
  <div class="map-wrap">
    <!-- Place Map.svg and national_parks.svg in the SAME folder as this index.html -->
    <svg id="map" viewBox="0 0 1000 1600" role="img" aria-label="Interactive map of Norway with national parks (external SVGs)">
      <g id="viewport">
        <g id="basemap"></g>
        <g id="parks"></g>
        <g id="labels" aria-hidden="true"></g>
      </g>
    </svg>
  </div>

  <script src="https://unpkg.com/d3@7/dist/d3.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
  (async function(){
    const svg = d3.select('#map');
    const viewport = d3.select('#viewport');
    const gBase = d3.select('#basemap');
    const gParks = d3.select('#parks');
    const gLabels = d3.select('#labels');
    const resetBtn = document.getElementById('resetBtn');

    async function loadSVG(url, target){
      const resp = await fetch(url);
      if(!resp.ok) throw new Error(url + ' ' + resp.status);
      const text = await resp.text();
      const doc = new DOMParser().parseFromString(text, 'image/svg+xml');
      const srcSvg = doc.documentElement; // <svg>
      // Import children into target group
      const frag = document.createDocumentFragment();
      Array.from(srcSvg.childNodes).forEach(n => frag.appendChild(document.importNode(n, true)));
      target.node().appendChild(frag);
      // Return viewBox/size
      const vb = srcSvg.getAttribute('viewBox');
      const w = srcSvg.getAttribute('width');
      const h = srcSvg.getAttribute('height');
      return {vb, w, h};
    }

    let baseInfo, parksInfo;
    try{
      baseInfo  = await loadSVG('Map.svg', gBase);
      parksInfo = await loadSVG('national_parks.svg', gParks);
    } catch(e){
      console.error(e);
      alert('Could not load Map.svg or national_parks.svg. Use a local server (or GitHub Pages).');
      return;
    }

    function parseVB(vb){
      if(!vb) return null;
      const a = vb.trim().split(/\s+/).map(Number);
      return {x:a[0], y:a[1], w:a[2], h:a[3]};
    }
    const vbBase = parseVB(baseInfo.vb);
    const vbParks = parseVB(parksInfo.vb);

    // Use basemap viewBox for the root SVG if present
    if(vbBase){ svg.attr('viewBox', `${vbBase.x} ${vbBase.y} ${vbBase.w} ${vbBase.h}`); }
    // Align parks to basemap coordinate system if needed
    if(vbBase && vbParks){
      const sx = vbBase.w / vbParks.w;
      const sy = vbBase.h / vbParks.h;
      const tx = vbBase.x - vbParks.x * sx;
      const ty = vbBase.y - vbParks.y * sy;
      gParks.attr('transform', `translate(${tx},${ty}) scale(${sx},${sy})`);
      gLabels.attr('transform', `translate(${tx},${ty}) scale(${sx},${sy})`);
    }

    // Park shapes -> apply interactive class, remove inline colors so CSS wins
    const shapes = gParks.selectAll('path, polygon, rect, circle, ellipse');
    shapes.each(function(){
      this.removeAttribute('fill');
      this.removeAttribute('stroke');
    });
    shapes.classed('park', true).attr('tabindex', 0).attr('role','button');

    // Labels: if existing <text> present in parks layer, use them; else create based on <title> or id
    let labels = gParks.selectAll('text');
    labels.classed('label', true);

    if(labels.size() === 0){
      // Create labels for each shape at bbox center with name from <title> or id
      shapes.each(function(_, i){
        const el = this;
        const titleEl = el.querySelector && el.querySelector('title');
        const name = (titleEl && titleEl.textContent.trim()) || el.getAttribute('data-name') || el.id || ('Park ' + (i+1));
        try{
          const bb = el.getBBox();
          gLabels.append('text')
            .attr('class','label')
            .attr('x', bb.x + bb.width/2)
            .attr('y', bb.y + bb.height/2)
            .text(name);
        }catch(e){ /* ignore */ }
      });
      labels = gLabels.selectAll('text');
    }

    // Ensure label ids
    labels.each(function(_, i){ if(!this.id) this.id = 'label-' + (i+1); });

    // Pair each shape with nearest label (simple distance heuristic)
    const labelNodes = labels.nodes().map(n => {
      const bb = n.getBBox();
      return { id: n.id, node: n, cx: bb.x + bb.width/2, cy: bb.y + bb.height/2 };
    });
    shapes.each(function(){
      let bb;
      try{ bb = this.getBBox(); }catch(e){ return; }
      const cx = bb.x + bb.width/2, cy = bb.y + bb.height/2;
      let best = null, bestD = Infinity;
      for(const L of labelNodes){
        const dx = L.cx - cx, dy = L.cy - cy;
        const d2 = dx*dx + dy*dy;
        if(d2 < bestD){ bestD = d2; best = L; }
      }
      if(best){ this.setAttribute('data-label-id', best.id); }
    });

    function togglePark(el){
      const park = d3.select(el);
      const label = d3.select('#' + park.attr('data-label-id'));
      const isActive = park.classed('active');
      park.classed('active', !isActive);
      label.classed('active', !isActive);
    }

    shapes.on('click', (event)=> togglePark(event.currentTarget));
    shapes.on('keydown', (event)=>{
      if(event.key === 'Enter' || event.key === ' '){
        event.preventDefault();
        togglePark(event.currentTarget);
      }
    });

    // Zoom/pan (1x–4x)
    const zoom = d3.zoom().scaleExtent([1,4]).on('zoom', (event)=>{
      viewport.attr('transform', event.transform);
    });
    svg.call(zoom);

    // Reset zoom and selections
    resetBtn.addEventListener('click', ()=>{
      svg.transition().duration(250).call(zoom.transform, d3.zoomIdentity);
      d3.selectAll('.park.active').classed('active', false);
      d3.selectAll('.label.active').classed('active', false);
    });

    // Double-click to zoom to a shape
    shapes.on('dblclick', (event)=>{
      event.preventDefault();
      const node = event.currentTarget;
      const bbox = node.getBBox();
      const svgEl = svg.node();
      const {width, height} = svgEl.getBoundingClientRect();
      const scale = Math.min(4, Math.max(1, Math.min(width / (bbox.width * 1.5), height / (bbox.height * 1.5))));
      const tx = width/2 - scale * (bbox.x + bbox.width/2);
      const ty = height/2 - scale * (bbox.y + bbox.height/2);
      const t = d3.zoomIdentity.translate(tx, ty).scale(scale);
      svg.transition().duration(350).call(zoom.transform, t);
    });
  })();
  </script>
</body>
</html>
